<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kalaa-Setu — MVC Console</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-800">
  <!-- Header -->
  <header class="bg-white border-b">
    <div class="max-w-6xl mx-auto px-4 py-4 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
      <h1 class="text-xl font-semibold tracking-tight">Kalaa-Setu MVC</h1>
      <div class="flex flex-col sm:flex-row gap-2 w-full md:w-auto">
        <input id="baseUrl" type="text" class="w-full sm:w-[26rem] px-3 py-2 rounded-lg border focus:outline-none focus:ring focus:border-sky-400"
               placeholder="API Base URL, e.g. http://localhost:8000" />
        <button id="saveBase" class="px-4 py-2 rounded-lg bg-sky-600 text-white hover:bg-sky-700">Use API</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 grid gap-6">
    <!-- Text ➜ Video -->
    <section class="bg-white rounded-2xl shadow-sm border p-5">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold">Generate Video from Text</h2>
        <span class="text-xs rounded-full bg-slate-100 px-2 py-1">POST /generate/video_from_text</span>
      </div>

      <div class="grid gap-4 md:grid-cols-2">
        <div class="grid gap-3">
          <textarea id="txt_text" rows="7" class="w-full px-3 py-2 rounded-lg border focus:ring focus:border-sky-400"
            placeholder="Paste your script here..."></textarea>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm mb-1">Tone</label>
              <select id="txt_tone" class="w-full px-3 py-2 rounded-lg border">
                <option value="neutral">neutral</option>
                <option value="formal" selected>formal</option>
                <option value="friendly">friendly</option>
                <option value="enthusiastic">enthusiastic</option>
              </select>
            </div>
            <div>
              <label class="block text-sm mb-1">Language (src)</label>
              <select id="txt_lang" class="w-full px-3 py-2 rounded-lg border">
                <option value="eng_Latn" selected>English (eng_Latn)</option>
                <option value="hin_Deva">Hindi (hin_Deva)</option>
                <option value="tam_Taml">Tamil (tam_Taml)</option>
                <option value="tel_Telu">Telugu (tel_Telu)</option>
                <option value="ben_Beng">Bengali (ben_Beng)</option>
                <option value="mar_Deva">Marathi (mar_Deva)</option>
                <option value="guj_Gujr">Gujarati (guj_Gujr)</option>
                <option value="kan_Knda">Kannada (kan_Knda)</option>
                <option value="mal_Mlym">Malayalam (mal_Mlym)</option>
                <option value="pan_Guru">Punjabi (pan_Guru)</option>
                <option value="urd_Arab">Urdu (urd_Arab)</option>
              </select>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm mb-1">Domain</label>
              <select id="txt_domain" class="w-full px-3 py-2 rounded-lg border">
                <option value="general">general</option>
                <option value="governance" selected>governance</option>
                <option value="education">education</option>
                <option value="health">health</option>
              </select>
            </div>
            <div>
              <label class="block text-sm mb-1">Environment</label>
              <select id="txt_env" class="w-full px-3 py-2 rounded-lg border">
                <option value="neutral">neutral</option>
                <option value="official" selected>official</option>
                <option value="outdoor">outdoor</option>
                <option value="studio">studio</option>
              </select>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div class="flex items-center gap-2">
              <input id="txt_multiscene" type="checkbox" class="w-4 h-4">
              <label for="txt_multiscene" class="text-sm">Multi-scene</label>
            </div>
            <div>
              <label class="block text-sm mb-1">Max scenes</label>
              <input id="txt_maxscenes" type="number" min="2" max="10" value="6" class="w-full px-3 py-2 rounded-lg border" />
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm mb-1">Background music (optional)</label>
              <input id="txt_bgm" type="file" accept="audio/*" class="w-full" />
            </div>
            <div>
              <label class="block text-sm mb-1">BGM volume (dB)</label>
              <input id="txt_bgm_vol" type="number" step="1" min="-50" max="0" value="-20" class="w-full px-3 py-2 rounded-lg border" />
            </div>
          </div>

          <button id="btn_text2video" class="mt-1 inline-flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-sky-600 text-white hover:bg-sky-700">
            Generate Video
          </button>
        </div>

        <div class="grid gap-3">
          <div class="rounded-xl border bg-slate-50 p-3">
            <p class="text-sm font-medium mb-2">Preview</p>
            <video id="video_preview" class="w-full rounded-lg border bg-black aspect-video" controls></video>
            <div class="mt-2 flex items-center gap-3">
              <a id="video_download" class="px-3 py-2 rounded-lg bg-slate-800 text-white text-sm hidden">Download MP4</a>
              <span id="video_size" class="text-xs text-slate-500"></span>
            </div>
          </div>
          <div class="rounded-xl border bg-slate-50 p-3">
            <p class="text-sm font-medium mb-2">Status</p>
            <pre id="log_text" class="text-xs whitespace-pre-wrap font-mono text-slate-700"></pre>
          </div>
        </div>
      </div>
    </section>

    <!-- Metrics -->
    <section class="bg-white rounded-2xl shadow-sm border p-5">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold">Live Metrics</h2>
        <span class="text-xs rounded-full bg-slate-100 px-2 py-1">GET /metrics/stack</span>
      </div>
      <div class="grid gap-3 md:grid-cols-2">
        <div class="rounded-xl border bg-slate-50 p-3">
          <p class="text-sm font-medium mb-2">Stack Metrics</p>
          <pre id="log_metrics" class="text-xs whitespace-pre-wrap font-mono text-slate-700"></pre>
          <div class="flex gap-2 mt-2">
            <button id="btn_metrics_once" class="px-3 py-2 rounded-lg bg-slate-800 text-white text-sm">Refresh Once</button>
            <button id="btn_metrics_auto" class="px-3 py-2 rounded-lg bg-slate-700 text-white text-sm">Auto Refresh</button>
            <button id="btn_metrics_stop" class="px-3 py-2 rounded-lg bg-slate-600 text-white text-sm">Stop</button>
          </div>
        </div>
        <div class="rounded-xl border bg-slate-50 p-3">
          <p class="text-sm font-medium mb-2">Tips</p>
          <ul class="list-disc pl-6 text-xs text-slate-700">
            <li>Run on GPU for `audio_service` and `graphics_service` to meet latency targets</li>
            <li>Metrics show last inference/compose times per service</li>
          </ul>
        </div>
      </div>
    </section>
    <!-- Audio only -->
    <section class="bg-white rounded-2xl shadow-sm border p-5">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold">Generate Audio Only</h2>
        <span class="text-xs rounded-full bg-slate-100 px-2 py-1">POST /generate/audio_only</span>
      </div>

      <div class="grid gap-4 md:grid-cols-2">
        <div class="grid gap-3">
          <textarea id="aud_text" rows="6" class="w-full px-3 py-2 rounded-lg border focus:ring focus:border-sky-400"
            placeholder="Paste text for narration..."></textarea>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm mb-1">Tone</label>
              <select id="aud_tone" class="w-full px-3 py-2 rounded-lg border">
                <option value="neutral" selected>neutral</option>
                <option value="formal">formal</option>
                <option value="friendly">friendly</option>
              </select>
            </div>
            <div>
              <label class="block text-sm mb-1">Language (src)</label>
              <select id="aud_lang" class="w-full px-3 py-2 rounded-lg border">
                <option value="eng_Latn" selected>English (eng_Latn)</option>
                <option value="hin_Deva">Hindi (hin_Deva)</option>
                <option value="tam_Taml">Tamil (tam_Taml)</option>
                <option value="tel_Telu">Telugu (tel_Telu)</option>
                <option value="ben_Beng">Bengali (ben_Beng)</option>
              </select>
            </div>
          </div>

          <button id="btn_audio" class="mt-1 inline-flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-sky-600 text-white hover:bg-sky-700">
            Generate Audio
          </button>
        </div>

        <div class="grid gap-3">
          <div class="rounded-xl border bg-slate-50 p-3">
            <p class="text-sm font-medium mb-2">Preview</p>
            <audio id="audio_preview" class="w-full" controls></audio>
            <div class="mt-2 flex items-center gap-3">
              <a id="audio_download" class="px-3 py-2 rounded-lg bg-slate-800 text-white text-sm hidden">Download Audio</a>
              <span id="audio_size" class="text-xs text-slate-500"></span>
            </div>
          </div>
          <div class="rounded-xl border bg-slate-50 p-3">
            <p class="text-sm font-medium mb-2">Status</p>
            <pre id="log_audio" class="text-xs whitespace-pre-wrap font-mono text-slate-700"></pre>
          </div>
        </div>
      </div>
    </section>

    <!-- PIB URL ➜ Video -->
    <section class="bg-white rounded-2xl shadow-sm border p-5">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold">Generate Video from PIB URL</h2>
        <span class="text-xs rounded-full bg-slate-100 px-2 py-1">GET /generate_from_pib</span>
      </div>

      <div class="grid gap-4 md:grid-cols-2">
        <div class="grid gap-3">
          <input id="pib_url" type="url" class="w-full px-3 py-2 rounded-lg border"
                 placeholder="https://www.pib.gov.in/PressReleasePage.aspx?PRID=..." />
          <button id="btn_pib" class="inline-flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-sky-600 text-white hover:bg-sky-700">
            Generate Video
          </button>
        </div>

        <div class="grid gap-3">
          <div class="rounded-xl border bg-slate-50 p-3">
            <p class="text-sm font-medium mb-2">Preview</p>
            <video id="pib_preview" class="w-full rounded-lg border bg-black aspect-video" controls></video>
            <div class="mt-2 flex items-center gap-3">
              <a id="pib_download" class="px-3 py-2 rounded-lg bg-slate-800 text-white text-sm hidden">Download MP4</a>
              <span id="pib_size" class="text-xs text-slate-500"></span>
            </div>
          </div>
          <div class="rounded-xl border bg-slate-50 p-3">
            <p class="text-sm font-medium mb-2">Status</p>
            <pre id="log_pib" class="text-xs whitespace-pre-wrap font-mono text-slate-700"></pre>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="text-center text-xs text-slate-500 py-8">
    © <span id="y"></span> Kalaa-Setu
  </footer>

  <script>
    // ---------- utilities ----------
    const $ = (id) => document.getElementById(id);
    const setBusy = (el, busy) => {
      if (!el) return;
      busy ? el.setAttribute('disabled', 'disabled') : el.removeAttribute('disabled');
      el.classList.toggle('opacity-60', !!busy);
      el.classList.toggle('cursor-not-allowed', !!busy);
    };
    const humanBytes = (n) => {
      if (!n && n !== 0) return '';
      const units = ['B','KB','MB','GB']; let u=0; while(n>=1024 && u<units.length-1){ n/=1024; u++; }
      return `${n.toFixed(1)} ${units[u]}`;
    };

    // Persist base URL
    const defaultBase = window.location.origin.includes('http') ? window.location.origin : 'http://localhost:8000';
    $('baseUrl').value = localStorage.getItem('kalaa_api_base') || defaultBase;
    $('saveBase').onclick = () => {
      localStorage.setItem('kalaa_api_base', $('baseUrl').value.trim());
      alert('API base set to: ' + $('baseUrl').value.trim());
    };
    const apiBase = () => (localStorage.getItem('kalaa_api_base') || $('baseUrl').value || '').replace(/\/+$/,'');

    async function postJSON(path, body, expectBinary = false) {
      const endpointUrl = `${apiBase()}${path}`;
      const res = await fetch(endpointUrl, {
        method: 'POST',
        headers: expectBinary ? {} : {'Content-Type': 'application/json'},
        body: expectBinary ? body : JSON.stringify(body)
      });
      if (!res.ok) {
        const text = await res.text().catch(()=> '');
        throw new Error(`${res.status} ${res.statusText} — ${text || 'request failed'}`);
      }
      return expectBinary ? res.arrayBuffer() : res.json();
    }
    async function getBinary(path) {
      const endpointUrl = `${apiBase()}${path}`;
      const res = await fetch(endpointUrl);
      if (!res.ok) {
        const text = await res.text().catch(()=> '');
        throw new Error(`${res.status} ${res.statusText} — ${text || 'request failed'}`);
      }
      return res.arrayBuffer();
    }

    // ---------- Metrics ----------
    let metricsTimer = null;
    async function refreshMetricsOnce() {
      const log = $('log_metrics');
      try {
        const res = await fetch(`${apiBase()}/metrics/stack`);
        if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
        const data = await res.json();
        log.textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        log.textContent = 'Error: ' + e.message;
      }
    }
    $('btn_metrics_once').onclick = refreshMetricsOnce;
    $('btn_metrics_auto').onclick = () => {
      if (metricsTimer) return;
      metricsTimer = setInterval(refreshMetricsOnce, 2000);
      refreshMetricsOnce();
    };
    $('btn_metrics_stop').onclick = () => {
      if (metricsTimer) clearInterval(metricsTimer);
      metricsTimer = null;
    };

    // ---------- Text ➜ Video ----------
    $('btn_text2video').onclick = async () => {
      const log = $('log_text');
      const btn = $('btn_text2video');
      const text = $('txt_text').value.trim();
      const tone = $('txt_tone').value;
      const domain = $('txt_domain').value;
      const environment = $('txt_env').value;
      const language = $('txt_lang').value;

      log.textContent = '';
      if (!text) return log.textContent = 'Please enter some text.';

      try {
        setBusy(btn, true);
        log.textContent = 'Submitting...';
        const multi = $('txt_multiscene').checked;
        const maxScenes = parseInt($('txt_maxscenes').value || '6', 10);
        const endpointUrl = `${apiBase()}${multi ? '/generate/video_multiscene' : '/generate/video_from_text'}`;
        const body = multi ? { text, tone, domain, environment, language, max_scenes: maxScenes } : { text, tone, domain, environment, language };

        // Optional BGM file -> base64
        const bgmFile = $('txt_bgm').files && $('txt_bgm').files[0];
        if (bgmFile) {
          const arrayBuf = await bgmFile.arrayBuffer();
          const bytes = new Uint8Array(arrayBuf);
          let binary = '';
          for (let i = 0; i < bytes.length; i++) binary += String.fromCharCode(bytes[i]);
          body.bgm = btoa(binary);
          body.bgm_volume_db = parseFloat($('txt_bgm_vol').value || '-20');
        }
        const res = await fetch(endpointUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        if (!res.ok) {
          const textErr = await res.text().catch(()=> '');
          throw new Error(`${res.status} ${res.statusText} — ${textErr || 'request failed'}`);
        }
        const latencyAssets = res.headers.get('X-Latency-Assets-ms');
        const latencyVideo = res.headers.get('X-Latency-Video-ms');
        const latencyTotal = res.headers.get('X-Latency-Total-ms');
        const videoFps = res.headers.get('X-Video-FPS');
        const videoFrames = res.headers.get('X-Video-Frames');
        const buf = await res.arrayBuffer();
        const blob = new Blob([buf], { type: 'video/mp4' });
        const blobUrl = URL.createObjectURL(blob);
        $('video_preview').src = blobUrl;
        $('video_download').href = blobUrl;
        $('video_download').download = 'kalaa_video.mp4';
        $('video_download').classList.remove('hidden');
        $('video_size').textContent = humanBytes(blob.size);
        const parts = [];
        if (latencyAssets) parts.push(`assets: ${latencyAssets} ms`);
        if (latencyVideo) parts.push(`compose: ${latencyVideo} ms`);
        if (latencyTotal) parts.push(`total: ${latencyTotal} ms`);
        if (videoFps) parts.push(`fps: ${Number(videoFps).toFixed(1)}`);
        if (videoFrames) parts.push(`frames: ${videoFrames}`);
        log.textContent = parts.length ? `Done. Latency — ${parts.join(', ')}` : 'Done.';
      } catch (e) {
        log.textContent = 'Error: ' + e.message;
      } finally {
        setBusy(btn, false);
      }
    };

    // ---------- Audio only ----------
    $('btn_audio').onclick = async () => {
      const log = $('log_audio');
      const btn = $('btn_audio');
      const text = $('aud_text').value.trim();
      const tone = $('aud_tone').value;
      const language = $('aud_lang').value;

      log.textContent = '';
      if (!text) return log.textContent = 'Please enter text for audio.';

      try {
        setBusy(btn, true);
        log.textContent = 'Submitting...';
        const resp = await postJSON('/generate/audio_only', { text, tone, language });
        if (!resp || !resp.audio) throw new Error('Audio payload missing.');
        const src = 'data:audio/wav;base64,' + resp.audio;
        $('audio_preview').src = src;

        // Downloadable blob
        const byteChars = atob(resp.audio);
        const bytes = new Uint8Array(byteChars.length);
        for (let i = 0; i < byteChars.length; i++) bytes[i] = byteChars.charCodeAt(i);
        const blob = new Blob([bytes], { type: 'audio/wav' });
        const blobUrl = URL.createObjectURL(blob);
        $('audio_download').href = blobUrl;
        $('audio_download').download = 'kalaa_audio.wav';
        $('audio_download').classList.remove('hidden');
        $('audio_size').textContent = humanBytes(blob.size);

        log.textContent = 'Done.';
      } catch (e) {
        log.textContent = 'Error: ' + e.message;
      } finally {
        setBusy(btn, false);
      }
    };

    // ---------- PIB URL ➜ Video ----------
    $('btn_pib').onclick = async () => {
      const log = $('log_pib');
      const btn = $('btn_pib');
      const srcUrl = $('pib_url').value.trim();

      log.textContent = '';
      if (!srcUrl) return log.textContent = 'Please paste a PIB URL.';

      try {
        setBusy(btn, true);
        log.textContent = 'Fetching & generating...';
        const q = new URLSearchParams({ url: srcUrl }).toString();
        const endpointUrl = `${apiBase()}/generate_from_pib?${q}`;
        const res = await fetch(endpointUrl);
        if (!res.ok) {
          const textErr = await res.text().catch(()=> '');
          throw new Error(`${res.status} ${res.statusText} — ${textErr || 'request failed'}`);
        }
        const latencyAssets = res.headers.get('X-Latency-Assets-ms');
        const latencyVideo = res.headers.get('X-Latency-Video-ms');
        const latencyTotal = res.headers.get('X-Latency-Total-ms');
        const videoFps = res.headers.get('X-Video-FPS');
        const videoFrames = res.headers.get('X-Video-Frames');
        const buf = await res.arrayBuffer();
        const blob = new Blob([buf], { type: 'video/mp4' });
        const blobUrl = URL.createObjectURL(blob);
        $('pib_preview').src = blobUrl;
        $('pib_download').href = blobUrl;
        $('pib_download').download = 'kalaa_pib_video.mp4';
        $('pib_download').classList.remove('hidden');
        $('pib_size').textContent = humanBytes(blob.size);
        const parts = [];
        if (latencyAssets) parts.push(`assets: ${latencyAssets} ms`);
        if (latencyVideo) parts.push(`compose: ${latencyVideo} ms`);
        if (latencyTotal) parts.push(`total: ${latencyTotal} ms`);
        if (videoFps) parts.push(`fps: ${Number(videoFps).toFixed(1)}`);
        if (videoFrames) parts.push(`frames: ${videoFrames}`);
        log.textContent = parts.length ? `Done. Latency — ${parts.join(', ')}` : 'Done.';
      } catch (e) {
        log.textContent = 'Error: ' + e.message;
      } finally {
        setBusy(btn, false);
      }
    };

    // tiny helpers
    $('y').textContent = new Date().getFullYear();

    // surface any script errors so you can see them
    window.addEventListener('error', (e) => {
      alert('Script error: ' + (e?.error?.message || e.message));
      console.error(e.error || e);
    });
  </script>
</body>
</html>